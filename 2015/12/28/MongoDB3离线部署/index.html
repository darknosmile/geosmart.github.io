<!doctype html>
<html class="theme-next use-motion theme-next-mist">
<head>
  

<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />








  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5"/>




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1"/>


    <meta name="description" content="追求心智成长，记录技术点滴" />



  <meta name="keywords" content="MongoDB," />



  <link rel="alternate" href="/atom.xml" title="Geosmart's Notes" type="application/atom+xml" />



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1" />


<meta name="description" content="基于Ops Manager的MongoDB 3.2集群离线部署笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="MongoDB3离线部署">
<meta property="og:url" content="http://geosmart.github.io/2015/12/28/MongoDB3离线部署/index.html">
<meta property="og:site_name" content="Geosmart's Notes">
<meta property="og:description" content="基于Ops Manager的MongoDB 3.2集群离线部署笔记">
<meta property="og:image" content="https://docs.opsmanager.mongodb.com/master/_images/opsmanager-network-diagram-fullsize.png">
<meta property="og:image" content="https://docs.opsmanager.mongodb.com/master/_images/opsmanager-large.png">
<meta property="og:image" content="http://geosmart.github.io/01_deployment.png">
<meta property="og:image" content="http://geosmart.github.io/02_statis_chart.png">
<meta property="og:image" content="http://geosmart.github.io/03_statis_table.png">
<meta property="og:updated_time" content="2016-01-04T09:58:48.414Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MongoDB3离线部署">
<meta name="twitter:description" content="基于Ops Manager的MongoDB 3.2集群离线部署笔记">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> MongoDB3离线部署 | Geosmart's Notes </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="http://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->
  

  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?221699150bf25edfe6338d0a9f205159";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>



  <div class="container one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">Geosmart's Notes</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu menu-left">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br />
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br />
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br />
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br />
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            <i class="menu-item-icon icon-next-about"></i> <br />
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-commonweal">
          <a href="/404.html" rel="section">
            <i class="menu-item-icon icon-next-commonweal"></i> <br />
            公益404
          </a>
        </li>
      

      
      
    </ul>
  

  
    <div class="site-search">
      
  
  <form class="site-search-form">
    <input type="text" id="st-search-input" class="st-search-input st-default-search-input" />
  </form>


<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install', 'sx6vPCUTjNbABKwx8Vig','2.0.0');
</script>



    </div>
  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              MongoDB3离线部署
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          发表于
          <time itemprop="dateCreated" datetime="2015-12-28T21:03:12+08:00" content="28   December   2015">
            28   December   2015
          </time>
        </span>

        
          <span class="post-category" >
            &nbsp; | &nbsp; 分类于
            
              <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                <a href="/categories/数据库/" itemprop="url" rel="index">
                  <span itemprop="name">数据库</span>
                </a>
              </span>

              
              

            
          </span>
        

        
          
            <span class="post-comments-count">
              &nbsp; | &nbsp;
              <a href="/2015/12/28/MongoDB3离线部署/#comments" itemprop="discussionUrl">
                <span class="post-comments-count ds-thread-count" data-thread-key="2015/12/28/MongoDB3离线部署/" itemprop="commentsCount"></span>
              </a>
            </span>
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><p>基于Ops Manager的MongoDB 3.2集群离线部署笔记</p>
<hr>
<a id="more"></a>
<h1 id="MongoDB3带来的改变">MongoDB3带来的改变</h1><p>MongoDB 3.0新版重点主要在效能的提升以及可扩展性，这些改变来自于储存层（Storage Layer）的强化，<br>MongoDB 2.8版本开始引入支持Latch-free、Non-blocking算法的WiredTiger储存引擎，因此可以开始使用新硬件才有的功能，比如大量的高速缓存（On-chip Cache）和多执行架构。<br>MongoDB 3.0 还提供了企业Ops Manager管理工具，用来管理大规模的 MongoDB 架构。</p>
<h2 id="个人测试">个人测试</h2><ol>
<li>数据恢复（mongorestore）支持并行导入了，性能有所提升；</li>
<li>数据存储变成了*.wt后缀的，待确认具体更新；</li>
</ol>
<p>MongoDB的管理服务（MMS）是用于监控和备份MongoDB的基础设施服务。其中监控的服务是免费的，备份的服务是需要收费的。</p>
<h1 id="Ops_Manager">Ops Manager</h1><p><code>The Best Way to Run MongoDB: Ops Manager</code><br><a href="https://www.mongodb.com/products/ops-manager">Ops Manager官网</a></p>
<p>Ops Manager能做什么？</p>
<blockquote>
<p>Deployment. Any topology, at any scale<br>Management. Deploy new clusters. Manage, monitor, and back up existing ones<br>Upgrades. In minutes, with no downtime<br>Scaling. Add capacity, without taking the application offline<br>Point-in-time, Scheduled Backups. Restore to any point in time, because disasters aren’t predictable<br>Performance Alerts. Monitor 100+ system metrics and get custom alerts before the system degrades<br>Add Query Optimization. Identify slow-running queries, get index suggestions, automate index builds</p>
</blockquote>
<h1 id="安装步骤">安装步骤</h1><h2 id="服务器准备">服务器准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mms应用服务器</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#mms监控数据服务器，Monitor Agent部署</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.51</span></span><br><span class="line"></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.52</span>：shard</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.54</span>：config server</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.58</span>：mongos</span><br></pre></td></tr></table></figure>
<h2 id="域名解析配置">域名解析配置</h2><h3 id="HostName配置/FQDN配置">HostName配置/FQDN配置</h3><p>FQDN是Fully Qualified Domain Name的缩写, 含义是完整的域名. 例如, 一台机器主机名(hostname)是www, 域后缀(domain)是example.com, 那么该主机的FQDN应该是www.example.com.<br>注意：hosts配置不当，后面server和agent间通讯会存在问题，参考host配置如下：</p>
<ul>
<li>server/agent配置(master)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/hosts</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># localhost</span></span><br><span class="line"><span class="number">127.0</span>.<span class="number">0.1</span> localhost.localdomain localhost</span><br><span class="line"></span><br><span class="line"><span class="comment">#mongodb ops manager server</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.80</span>   opsserver.lt.com opsserver</span><br><span class="line"></span><br><span class="line"><span class="comment">#mongodb ops monitor agent</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.51</span>   opsagent1.lt.com opsagent1</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.52</span>   opsagent2.lt.com opsagent2</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.53</span>   opsagent3.lt.com opsagent3</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.54</span>   opsagent4.lt.com opsagent4</span><br><span class="line"><span class="number">192.168</span>.<span class="number">1.58</span>   opsagent8.lt.com opsagent8</span><br></pre></td></tr></table></figure>
<h3 id="network配置">network配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /etc/sysconfig/network</span></span><br><span class="line">NETWORKING=yes</span><br><span class="line">HOSTNAME=opsserver</span><br><span class="line">NTPSERVERARGS=iburst</span><br></pre></td></tr></table></figure>
<h2 id="安装Ops_Manager_Application_Database">安装Ops Manager Application Database</h2><p>可选：Backup Database</p>
<p>设置最大文件打开数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim /etc/rc.local</span></span><br><span class="line"><span class="built_in">ulimit</span> -n <span class="number">65536</span></span><br></pre></td></tr></table></figure></p>
<p>##　安装Ops Manager集群监控</p>
<h3 id="关于Ops_Manager">关于Ops Manager</h3><p><a href="https://www.mongodb.com/presentations/webinar-introducing-ops-manager">视频教程</a><br><a href="http://www.slideshare.net/mongodb/ops-manager-webinar-mar-5-2015">视频教程</a></p>
<p><a href="https://docs.opsmanager.mongodb.com/master/application/">介绍文档</a><br>MongoDB Ops Manager is a service for managing, monitoring and backing up a MongoDB infrastructure. Ops Manager provides the services described here.<br><img src="https://docs.opsmanager.mongodb.com/master/_images/opsmanager-network-diagram-fullsize.png" alt="组成部分"></p>
<p><img src="https://docs.opsmanager.mongodb.com/master/_images/opsmanager-large.png" alt="Production Install with a Highly Available Ops Manager Application and Multiple Backup Databases¶"></p>
<p>备注：目前Ops Manager只能完成从无到有的集群部署，sharding集群的shard key等配置需在xshell中手动配置</p>
<h3 id="centos6安装Ops_Manager">centos6安装Ops Manager</h3><p><a href="https://docs.opsmanager.mongodb.com/current/tutorial/install-on-prem-with-rpm-packages/">RPM安装参考教程</a><br><a href="http://www.ttlsa.com/mms/follow-me-to-use-mongodb-mms-services/">中文配置教程</a></p>
<ol>
<li>配置ops manager application data数据服务器（192.168.1.51），安装mongodb并启动服务<br>从其他机器复制mongodb：<code>scp -r root@192.168.1.52:/usr/local/mongodb /usr/local</code></li>
<li>安装ops manager server<ul>
<li>复制到<code>mongodb-mms-2.0.0.327-1.x86_64.rpm</code>到<code>/mnt</code></li>
<li>执行<code>sudo rpm -ivh  /mnt/mongodb-mms-2.0.0.327-1.x86_64.rpm</code>，mms将默认安装到<code>/opt/mongodb/mms/</code></li>
<li>配置/opt/mongodb/mms/conf/conf-mms.properties,设置mongo.mongoUri等参数</li>
<li>启动服务<code>sudo service mongodb-mms start</code></li>
<li>设置mongodb-mms为开机自启动：chkconfig  mongodb-mms  on</li>
<li>登录http://<host>:8080/注册用户</li>
</ul>
</li>
<li>agent节点分别配置安装automation agent  </li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以下具体参数参考http://192.168.1.80:8080/settings/agents/中的Automation选项卡的操作步骤</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Download the agent</span></span><br><span class="line">curl -OL http://<span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">8080</span>/download/agent/automation/mongodb-mms-automation-agent-manager-<span class="number">2.5</span>.<span class="number">11.1484</span>-<span class="number">1</span>.x86_64.rpm</span><br><span class="line"><span class="comment">#and install the package.</span></span><br><span class="line">sudo rpm -U mongodb-mms-automation-agent-manager-<span class="number">2.5</span>.<span class="number">11.1484</span>-<span class="number">1</span>.x86_64.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment">#Open the config file</span></span><br><span class="line">sudo vi /etc/mongodb-mms/automation-agent.config</span><br><span class="line"><span class="comment">#配置唯一 API key, Group ID, and Ops Manager Base URL</span></span><br><span class="line">mmsGroupId=<span class="number">568486</span>a424ac2c591d35e00c</span><br><span class="line">mmsApiKey=e4db7d0b6757a704271d04e25748ac41</span><br><span class="line">mmsBaseUrl=http://<span class="number">192.168</span>.<span class="number">1.80</span>:<span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#Prepare a directory in which to store your MongoDB data. This directory must be owned by the mongod user. Any directory is fine, but the default is /data. This directory can be created with a command similar to below.</span></span><br><span class="line">sudo mkdir /data</span><br><span class="line">sudo chown mongod:mongod /data</span><br><span class="line"></span><br><span class="line"><span class="comment">#Start the agent.</span></span><br><span class="line">sudo service mongodb-mms-automation-agent start</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置mongodb-mms-automation-agent为开机自启动</span></span><br><span class="line">chkconfig  mongodb-mms-automation-agent on</span><br></pre></td></tr></table></figure>
<p>其他shard节点可从monitor节点复制automation-agent配置文件：<code>scp root@192.168.1.51:/etc/mongodb-mms/automation-agent.config /etc/mongodb-mms/automation-agent.config</code><br>重启automation-agent服务：<code>sudo service mongodb-mms-automation-agent restart</code></p>
<ol>
<li>在web控制台Deployment中选1台性能较好的服务器配置monitoring agent（如在ops manager application data数据服务器）</li>
<li>zai Deployment模块Add New Cluster,配置mongos,config server和shards</li>
<li>集群测试<br>服务器主机名regex过滤:(opsagent2|opsagent4|opsagent8)<br>集群服务器配置:mongos:1/mongod:3/config server:1<br>端口配置，shards(27000-28000),mongos(27017)config server(27019)<br>分片数配置<br>配置完成确认执行后，ops会按顺序自动安装部署shard&gt;config server&gt;mongos，再也不用kb手动去安装了！<br>mongodb安装的默认位置：/var/lib/mongodb-mms-automation</li>
</ol>
<h3 id="windows_server安装Ops_Manager">windows server安装Ops Manager</h3><p><a href="https://docs.opsmanager.mongodb.com/current/tutorial/install-on-prem-windows/">参考教程</a></p>
<ol>
<li>安装mongodb</li>
<li>安装Install Ops Manager</li>
<li>配置<code>C:\MMSData\Server\Config\conf-mms.properties</code>（默认路径）中的<code>mongo.mongoUri</code>等连接配置属性</li>
<li>在windows服务列表启动服务<code>MongoDB Ops Manager HTTP Service</code></li>
<li>登录http://<host>:8080/注册用户，admin/1qaz@WSX</li>
</ol>
<h3 id="问题记录">问题记录</h3><ol>
<li>No MongoDB versions have been made available for use in your deployment. Visit the Version Manager to enable MongoDB versions.<br>重新配置，将version manager参数设置为internet而非local</li>
<li>There are a mix of Agents that are installed manually and managed by your Automation Agents. This configuration is not supported.<br>You will not be able to add new hosts to monitoring or create new automated hosts while in this state. The Agents that should be removed are indicated on the table above.<br>After stopping an Agent it can take up to 5 minutes to take effect.</li>
<li>添加集群报错： Unable to create member 2 of myShard_0. Unable to find enough servers. Requested port range was 27000 to 27000. Excluding port ranges 27019 to 27019, 27017 to 27017. Please ensure all agents are running.<br>shard server port设置在27000-28000范围内，不能设置为27000</li>
<li>mongos服务无法启动<br>错误日志：<code>not master or secondary; cannot currently read from this replSet member ns,config.settings query,config.shards query</code><br>解决方案：pkill mongod 强制关闭mongo进程，删除/data目录内的shard数据(不能删automation的数据)，重新添加集群</li>
<li>shard集群分片测试，目前数据量小，数据存储表现为replica set，待测试分片效果！</li>
</ol>
<h1 id="MongoDB离线部署配置">MongoDB离线部署配置</h1><p><a href="https://docs.opsmanager.mongodb.com/v2.0/tutorial/configure-local-mode/">Configure Local Mode if Servers Have No Internet Access</a></p>
<h2 id="设置为Local">设置为Local</h2><p>在Ops Manager控制台，单击右上角Admin，General&gt;Ops Manager Config&gt; Miscellaneous&gt;设置Version Manifest Source 为Local<br>设置 Versions Directory存储MongoDB binaries，默认<code>/opt/mongodb/mms/mongodb-releases</code></p>
<h2 id="下载MongoDB离线Binaries">下载MongoDB离线Binaries</h2><p>cd /opt/mongodb/mms/mongodb-releases<br>curl -OL <a href="http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.2.0.tgz">http://fastdl.mongodb.org/linux/mongodb-linux-x86_64-rhel62-3.2.0.tgz</a></p>
<h2 id="设置Versions_Directory目录权限">设置Versions Directory目录权限</h2><ol>
<li>查看目录权限：<code>ls -l /opt/mongodb/mms/mongodb-releases</code></li>
<li>设置mongodb-mms用户对Versions Directory中文件有读写权限：<code>sudo chown -R  mongodb-mms:mongodb-mms /opt/mongodb/mms/mongodb-releases</code></li>
</ol>
<h2 id="编辑conf-mms-properties">编辑conf-mms.properties</h2><p>在conf-mms.propertie最后新增两行<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#vim /opt/mongodb/mms/conf/conf-mms.properties</span></span><br><span class="line">automation.versions.source=<span class="built_in">local</span></span><br><span class="line">automation.versions.directory=/opt/mongodb/mms/mongodb-releases/</span><br></pre></td></tr></table></figure></p>
<h2 id="重启服务">重启服务</h2><p><code>sudo service mongodb-mms restart</code></p>
<h2 id="部署截图">部署截图</h2><p><img src="01_deployment.png" alt="deployment"><br><img src="02_statis_chart.png" alt="statis_chart"><br><img src="03_statis_table.png" alt="statis_table"></p>
<h2 id="Version_Manager配置MongoDB版本">Version Manager配置MongoDB版本</h2><p>在Ops Manager控制台，Deployment&gt;Version Manager&gt;选择离线的mongodb版本&gt;Review &amp; Deploy&gt;Confirm &amp; Deploy.</p>
<h1 id="MongoDB_数据备份与恢复">MongoDB 数据备份与恢复</h1><p><a href="https://docs.mongodb.org/manual/tutorial/backup-small-sharded-cluster-with-mongodump/">backup-small-sharded-cluster-with-mongodump</a><br>在mongodb primary节点执行mongorestore<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/lib/mongodb-mms-automation/mongodb-linux-x86_64-<span class="number">3.2</span>.<span class="number">0</span>/bin</span><br><span class="line">mongorestore -drop  <span class="operator">-d</span> uadb  /mnt/dump/dump/uadb_dump/uadb</span><br><span class="line">mongorestore -drop  <span class="operator">-d</span> uadb_attachment  /mnt/dump/dump/uadb_attachment_dump/uadb_attachment</span><br></pre></td></tr></table></figure></p>
<h1 id="Route_Server配置chunk_size">Route Server配置chunk size</h1><p><a href="https://docs.mongodb.org/manual/tutorial/modify-chunk-size-in-sharded-cluster/">参考文档：modify-chunk-size-in-sharded-cluster</a></p>
<h2 id="注意事项">注意事项</h2><ol>
<li>Automatic splitting only occurs on insert or update.</li>
<li>If you lower the chunk size, it may take time for all chunks to split to the new size.</li>
<li>Splits cannot be undone.</li>
<li>If you increase the chunk size, existing chunks grow only through insertion or updates until they reach the new size.</li>
<li>The allowed range of the chunk size is between 1 and 1024 megabytes, inclusive.</li>
</ol>
<h2 id="修改步骤">修改步骤</h2><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#36830;&#25509;Route Server(mongos shell)&#10;/var/lib/mongodb-mms-automation/mongodb-linux-x86_64-3.2.0/bin/mongo opsagent2.lt.com:27017  &#10; #&#20999;&#25442;&#21040;config&#25968;&#25454;&#24211;&#10; use config&#10; #&#20462;&#25913;chunk size&#10; db.settings.save( &#123; _id:&#34;chunksize&#34;, value: &#60;sizeInMB&#62; &#125; )&#10; &#22914; db.settings.save( &#123; _id:&#34;chunksize&#34;, value: 64 &#125; )</span><br></pre></td></tr></table></figure>
<h1 id="数据库启用分片：enableSharding">数据库启用分片：enableSharding</h1><p><a href="https://docs.mongodb.org/manual/tutorial/deploy-shard-cluster/">参考文档：deploy-shard-cluster</a><br><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#36830;&#25509;&#20197;mingo&#36830;&#25509;route server&#65288;mongo shell&#65289;&#10;mongo --host &#60;hostname of machine running mongos&#62; --port &#60;port mongos listens on&#62;&#10;&#22914;/var/lib/mongodb-mms-automation/mongodb-linux-x86_64-3.2.0/bin/mongo --host opsagent2.lt.com --port 27017&#10;#&#21551;&#29992;&#20998;&#29255;&#10;sh.enableSharding(&#34;&#60;database&#62;&#34;) &#25110;&#32773; db.runCommand( &#123; enableSharding: &#60;database&#62; &#125; )&#10;&#22914;&#10;sh.enableSharding(&#34;uadb&#34;)&#10;sh.enableSharding(&#34;uadb_attachment&#34;)&#10;&#25110;&#10;use admin&#10;db.runCommand( &#123; enableSharding: &#34;uadb&#34;&#125; );&#10;db.runCommand( &#123; enableSharding: &#34;uadb_attachment&#34;&#125; );&#10;# collection&#20998;&#29255;&#10;sh.shardCollection(&#34;&#60;database&#62;.&#60;collection&#62;&#34;, shard-key-pattern)&#10;&#22914; sh.shardCollection(&#34;uadb.AddressNode&#34;, &#123; &#34;_id&#34;: 1, &#34;ruleabbr&#34;: 1 &#125; )&#10;#&#26597;&#30475;&#26159;&#21542;&#25104;&#21151;&#21551;&#29992;&#20998;&#29255;&#10;use uadb;&#10;db.AddressNode.stats();</span><br></pre></td></tr></table></figure></p>
<h1 id="shard集群测试">shard集群测试</h1><p><a href="http://janephp.blog.51cto.com/4439680/1330656">Sharding 分片分片测试</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mongo连接admin库</span></span><br><span class="line">/var/lib/mongodb-mms-automation/mongodb-linux-x86_64-<span class="number">3.2</span>.<span class="number">0</span>/bin/mongo admin --host opsagent2.lt.com --port <span class="number">27017</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#设置分片存储数据库</span></span><br><span class="line">sh.enableSharding(<span class="string">"test"</span>)</span><br><span class="line">sh.shardCollection(<span class="string">'test.users'</span>, &#123; <span class="string">"_id"</span>: <span class="number">1</span>&#125; )</span><br><span class="line"></span><br><span class="line"><span class="comment">#插入测试数据</span></span><br><span class="line">use <span class="built_in">test</span></span><br><span class="line"><span class="keyword">for</span>(var i=<span class="number">1</span>;i&lt;<span class="number">50000</span>;i++) db.users.insert(&#123;age:i,name:<span class="string">'geosmart'</span>,address:<span class="string">'anhui_chuzhou'</span>,country:<span class="string">'china'</span>&#125;)</span><br><span class="line"><span class="comment">#查询分片状态</span></span><br><span class="line">db.users.stats();</span><br></pre></td></tr></table></figure></p>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MongoDB/" rel="tag">#MongoDB</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/2015/12/28/MongoDB权限配置/" rel="prev">MongoDB权限配置</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/2015/12/28/MongoDB空间分析/" rel="next">MongoDB空间分析</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        

        
          <div class="comments" id="comments">
            
              <div class="ds-thread" data-thread-key="2015/12/28/MongoDB3离线部署/"
                   data-title="MongoDB3离线部署" data-url="http://geosmart.github.io/2015/12/28/MongoDB3离线部署/">
              </div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" src="https://avatars1.githubusercontent.com/u/3156608?v=3&s=460" alt="geosmart" itemprop="image"/>
          <p class="site-author-name" itemprop="name">geosmart</p>
        </div>
        <p class="site-description motion-element" itemprop="description">追求心智成长，记录技术点滴</p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">50</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">14</span>
              <span class="site-state-item-name">分类</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">50</span>
              <span class="site-state-item-name">标签</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#MongoDB3带来的改变"><span class="nav-number">1.</span> <span class="nav-text">MongoDB3带来的改变</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#个人测试"><span class="nav-number">1.1.</span> <span class="nav-text">个人测试</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ops_Manager"><span class="nav-number">2.</span> <span class="nav-text">Ops Manager</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#安装步骤"><span class="nav-number">3.</span> <span class="nav-text">安装步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#服务器准备"><span class="nav-number">3.1.</span> <span class="nav-text">服务器准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#域名解析配置"><span class="nav-number">3.2.</span> <span class="nav-text">域名解析配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#HostName配置/FQDN配置"><span class="nav-number">3.2.1.</span> <span class="nav-text">HostName配置/FQDN配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#network配置"><span class="nav-number">3.2.2.</span> <span class="nav-text">network配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Ops_Manager_Application_Database"><span class="nav-number">3.3.</span> <span class="nav-text">安装Ops Manager Application Database</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#关于Ops_Manager"><span class="nav-number">3.3.1.</span> <span class="nav-text">关于Ops Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#centos6安装Ops_Manager"><span class="nav-number">3.3.2.</span> <span class="nav-text">centos6安装Ops Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#windows_server安装Ops_Manager"><span class="nav-number">3.3.3.</span> <span class="nav-text">windows server安装Ops Manager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#问题记录"><span class="nav-number">3.3.4.</span> <span class="nav-text">问题记录</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MongoDB离线部署配置"><span class="nav-number">4.</span> <span class="nav-text">MongoDB离线部署配置</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#设置为Local"><span class="nav-number">4.1.</span> <span class="nav-text">设置为Local</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下载MongoDB离线Binaries"><span class="nav-number">4.2.</span> <span class="nav-text">下载MongoDB离线Binaries</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#设置Versions_Directory目录权限"><span class="nav-number">4.3.</span> <span class="nav-text">设置Versions Directory目录权限</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#编辑conf-mms-properties"><span class="nav-number">4.4.</span> <span class="nav-text">编辑conf-mms.properties</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#重启服务"><span class="nav-number">4.5.</span> <span class="nav-text">重启服务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署截图"><span class="nav-number">4.6.</span> <span class="nav-text">部署截图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Version_Manager配置MongoDB版本"><span class="nav-number">4.7.</span> <span class="nav-text">Version Manager配置MongoDB版本</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MongoDB_数据备份与恢复"><span class="nav-number">5.</span> <span class="nav-text">MongoDB 数据备份与恢复</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Route_Server配置chunk_size"><span class="nav-number">6.</span> <span class="nav-text">Route Server配置chunk size</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项"><span class="nav-number">6.1.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#修改步骤"><span class="nav-number">6.2.</span> <span class="nav-text">修改步骤</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据库启用分片：enableSharding"><span class="nav-number">7.</span> <span class="nav-text">数据库启用分片：enableSharding</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shard集群测试"><span class="nav-number">8.</span> <span class="nav-text">shard集群测试</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner"> <div class="copyright" >
  
  &copy; &nbsp; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="icon-next-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">geosmart</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>


 </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  
  
    

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"geosmart"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>
    
     
     
  	  <script type="text/javascript">
  		var duoshuo_user_ID = geosmart
      var duoshuo_admin_nickname="geosmart"
  	  </script>
     
  	<script src="/js/ua-parser.min.js"></script>
  	<script src="/js/hook-duoshuo.js"></script>
  

    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  

  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
</body>
</html>
